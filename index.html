 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GeoSpot - 3D Flat Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.css" rel="stylesheet" />
  <style>
    /* --- Base Styles --- */
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #040b17; color: #fff; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }

    /* --- UI Container & Scoreboard --- */
    #ui-container { position: absolute; top: 0; left: 0; right: 0; padding: 15px; z-index: 2; pointer-events: none; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    #scoreboard { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; pointer-events: auto; gap: 15px; flex-wrap: wrap; /* Allow wrapping */ }
    #scoreboard-left, #scoreboard-center, #scoreboard-right { display: flex; align-items: center; gap: 10px; }
    #scoreboard-left { flex-shrink: 0; } #scoreboard-center { flex-grow: 1; justify-content: center; } #scoreboard-right { flex-shrink: 0; }
    .score-pill { background: rgba(0, 100, 0, 0.8); color: #ffffff; border-radius: 20px; padding: 8px 15px; font-size: 14px; font-weight: bold; box-shadow: 0 1px 4px rgba(0,0,0,0.4); text-align: center; backdrop-filter: blur(3px); border: 1px solid rgba(255, 255, 255, 0.2); transition: background-color 0.3s ease, transform 0.1s ease; white-space: nowrap; }
    .score-pill#countryTab { padding: 10px 20px; font-size: 16px; min-width: 180px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; }
    #gameTitle { font-size: 16px; line-height: 1.2; background-color: rgba(0, 80, 0, 0.8); }
    #gameSubtitle { font-size: 11px; font-weight: normal; display: block; margin-top: 2px; opacity: 0.8; }

    /* --- Exit Button --- */
    #exitGameBtn { background-color: #a03d3d; border-color: rgba(255, 150, 150, 0.3); padding: 8px 15px; font-size: 14px; cursor: pointer; }
    #exitGameBtn:hover { background-color: #c04d4d; }
    #exitGameBtn:active { transform: scale(0.98); }
    /* REMOVED old #backToMenuBtn styles */

    /* NEW: Tracker Back Button */
    #trackerBackBtn {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 5; /* Above scoreboard items if they somehow overlap */
        background: rgba(68, 68, 68, 0.8); /* #444 */
        color: #ffffff;
        border-radius: 20px;
        padding: 8px 15px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 1px 4px rgba(0,0,0,0.4);
        backdrop-filter: blur(3px);
        border: 1px solid #777; /* rgba(255, 255, 255, 0.2); */
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease;
        pointer-events: auto; /* Make it clickable */
    }
    #trackerBackBtn:hover { background-color: #666; }
    #trackerBackBtn:active { transform: scale(0.98); }


    /* --- Feedback --- */
    #feedback { text-align: center; font-size: 18px; font-weight: bold; padding: 10px; background: rgba(0, 0, 0, 0.7); border-radius: 8px; max-width: 600px; width: fit-content; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); margin-top: 5px; }
    #feedback.visible { opacity: 1; }
    #feedback.correct { color: #4CAF50; background: rgba(76, 175, 80, 0.2); border: 1px solid rgba(76, 175, 80, 0.5); }
    #feedback.incorrect { color: #f44336; background: rgba(244, 67, 54, 0.2); border: 1px solid rgba(244, 67, 54, 0.5); }
    #feedback.info { color: #2196F3; background: rgba(33, 150, 243, 0.2); border: 1px solid rgba(33, 150, 243, 0.5); }

    /* --- Splash Screen --- */
    #splash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('cover.png') no-repeat center center; background-color: #040b17; background-size: cover; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; font-size: 24px; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); pointer-events: auto; transition: opacity 0.5s ease-out; }
    #splash.hidden { opacity: 0; pointer-events: none; }
    #settings { background: rgba(0, 0, 0, 0.8); padding: 25px 40px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.6); margin-top: 30px; backdrop-filter: blur(5px); width: 80%; max-width: 500px; /* Make width relative */ }
    #settings label { display: block; margin-bottom: 15px; font-size: 16px; color: #eee; }
    #settings select, #settings input[type="checkbox"] { font-size: 15px; margin-left: 10px; vertical-align: middle; }
    #settings input[type="checkbox"] { transform: scale(1.2); }
    #startBtn { padding: 12px 25px; font-size: 18px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 6px; transition: background-color 0.3s, transform 0.1s; margin-top: 10px; }
    #startBtn:hover { background-color: #45a049; } #startBtn:active { transform: scale(0.98); }
    #travelMapBtn { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #2196F3; color: white; border: none; border-radius: 6px; transition: background-color 0.3s, transform 0.1s; margin-top: 15px; }
    #travelMapBtn:hover { background-color: #1976D2; } #travelMapBtn:active { transform: scale(0.98); }

    /* --- Star Explosion --- */
    @keyframes explode { 0% { opacity: 1; transform: translate(0, 0) scale(1); } 100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.1); } }
    .star-explosion { position: fixed; width: 14px; height: 14px; background: gold; border-radius: 50%; pointer-events: none; z-index: 9999; animation: explode 0.8s ease-out forwards; }

    /* --- Footer --- */
    #footer { position: absolute; bottom: 10px; width: 100%; text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 12px; z-index: 1; text-shadow: 0 0 3px black; pointer-events: none; }

    /* --- Bottom Left Controls --- */
    #bottom-left-controls { position: absolute; bottom: 15px; left: 15px; z-index: 3; background: rgba(0, 0, 0, 0.6); padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; pointer-events: auto; backdrop-filter: blur(3px); border: 1px solid rgba(255, 255, 255, 0.2); }
    #muteBtn { padding: 5px 10px; font-size: 14px; cursor: pointer; background-color: #555; color: white; border: 1px solid #888; border-radius: 4px; min-width: 70px; text-align: center; transition: background-color 0.3s ease;}
    #muteBtn:hover { background-color: #777; }
    #volumeControl label { font-size: 12px; margin-right: 5px; vertical-align: middle; }
    #volumeSlider { vertical-align: middle; cursor: pointer; width: 100px; }

    /* --- Bottom Right Incorrect List --- */
    #incorrect-list-container { position: absolute; bottom: 15px; right: 15px; z-index: 3; background: rgba(100, 0, 0, 0.7); padding: 10px 15px; border-radius: 8px; pointer-events: auto; backdrop-filter: blur(3px); border: 1px solid rgba(255, 100, 100, 0.3); max-height: 200px; overflow-y: auto; max-width: 200px; color: #eee; display: none; }
    #incorrect-list-container.visible { display: block; }
    #incorrect-list-container h4 { margin: 0 0 8px 0; font-size: 14px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 4px; text-align: center; }
    #incorrect-list { list-style: none; padding: 0; margin: 0; font-size: 13px; }
    #incorrect-list li { padding: 2px 0; opacity: 0.9; }

    /* --- Tracker Legend --- */
    #tracker-legend {
        position: absolute;
        bottom: 10px; /* Align with footer */
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.75);
        color: #eee;
        padding: 8px 15px;
        border-radius: 15px;
        font-size: 13px;
        z-index: 3; /* Above map, potentially below controls if needed */
        text-align: center;
        pointer-events: none; /* Don't intercept clicks */
        backdrop-filter: blur(3px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    #tracker-legend span { /* Style the colored text */
        display: inline-block;
        padding: 0 3px;
    }

    /* --- Responsive Styles --- */
    @media (max-width: 768px) {
        #scoreboard {
            gap: 8px; /* Reduce gap */
            padding: 10px;
            justify-content: center; /* Center items when wrapping */
        }
        #scoreboard-left, #scoreboard-center, #scoreboard-right {
            gap: 8px;
            margin-bottom: 5px; /* Add space if they wrap */
        }
        #scoreboard-center {
           order: -1; /* Move country name to top on wrap */
           width: 100%; /* Take full width when wrapped */
           justify-content: center;
        }
         #scoreboard-left {
            justify-content: center; /* Center title */
            flex-grow: 1; /* Allow left/right to take space */
         }
         #scoreboard-right {
            justify-content: center; /* Center score/round/streak */
             flex-grow: 1;
         }
        .score-pill {
            padding: 6px 10px;
            font-size: 12px;
        }
        .score-pill#countryTab {
            padding: 8px 15px;
            font-size: 14px;
            min-width: 150px;
        }
        #gameTitle { font-size: 14px; }
        #gameSubtitle { font-size: 10px; }
        #exitGameBtn { font-size: 12px; padding: 6px 10px; }
        #trackerBackBtn { font-size: 12px; padding: 6px 10px; top: 10px; right: 10px; } /* Adjust new button too */

        #feedback { font-size: 16px; max-width: 90%; padding: 8px; }

        #settings { padding: 20px 15px; width: 90%; max-width: none; }
        #settings label { font-size: 15px; }
        #settings select, #settings input[type="checkbox"] { font-size: 14px; }
        #startBtn { padding: 12px 20px; font-size: 16px; }
        #travelMapBtn { padding: 10px 18px; font-size: 15px; }

        #bottom-left-controls {
            bottom: 10px; left: 10px; padding: 8px 10px; gap: 8px;
            flex-direction: column; /* Stack vertically */
            align-items: flex-start;
        }
        #muteBtn { font-size: 12px; padding: 4px 8px; }
        #volumeControl label { font-size: 11px; }
        #volumeSlider { width: 80px; }

        #incorrect-list-container {
            bottom: 10px; right: 10px; padding: 8px 10px; max-width: 120px; max-height: 150px;
        }
        #incorrect-list-container h4 { font-size: 13px; }
        #incorrect-list { font-size: 11px; }

        #tracker-legend {
            font-size: 11px; padding: 6px 10px; bottom: 5px; /* Adjust legend */
            max-width: calc(100% - 20px); /* Prevent overflow */
            box-sizing: border-box;
        }

        #footer { font-size: 10px; bottom: 5px; }

        /* Adjust Mapbox controls positioning if needed */
        .mapboxgl-ctrl-top-right { top: 55px; /* Move default controls down below our new back button */ }
        @media (max-width: 480px) {
             .mapboxgl-ctrl-top-right { top: 10px; } /* On very small screens maybe put it back */
             #trackerBackBtn { top: 60px; } /* Move our button below mapbox controls */
        }
    }

  </style>
</head>
<body>

<!-- UI Elements -->
<div id="ui-container">
  <div id="scoreboard" style="display: none;">
    <div id="scoreboard-left">
      <!-- REMOVED backToMenuBtn from here -->
      <div class="score-pill" id="gameTitle"> GeoSpot <span id="gameSubtitle">3D flat map: click the country!</span> </div>
    </div>
    <div id="scoreboard-center">
      <div class="score-pill" id="countryTab"> <span id="countryName">Loading...</span> <span id="timerDisplay" style="margin-left: 10px; font-weight: normal; opacity: 0.8;"></span> </div>
    </div>
    <div id="scoreboard-right">
      <div class="score-pill" id="scoreTab"> SCORE: <span id="totalScore">0</span> </div>
      <div class="score-pill" id="roundTab"> ROUND: <span id="round">0/10</span> </div>
      <div class="score-pill" id="streakTab"> STREAK: <span id="streak">0</span> </div>
      <button id="exitGameBtn" class="score-pill" style="display: none;">Exit Game</button>
    </div>
  </div>
  <div id="feedback" style="display: none;"></div>
</div>
<div id="map"></div>
<div id="splash">
  <div id="coverMessage">Welcome to GeoSpot!</div>
  <div id="settings">
    <label> Difficulty: <select id="difficulty" style="padding: 5px;"> <option value="tourist">Tourist (20s - Names Visible)</option> <option value="easy">Easy (30s)</option> <option value="medium" selected>Medium (20s)</option> <option value="hard">Hard (15s)</option> </select> </label>
    <label> <input type="checkbox" id="timerToggle" checked> Timer Enabled </label>
    <button id="startBtn" disabled>Loading Data...</button>
    <button id="travelMapBtn" disabled>My Travel Map</button>
  </div>
</div>

<div id="bottom-left-controls">
  <button id="muteBtn">Mute</button>
  <div id="volumeControl"> <label for="volumeSlider">Music:</label> <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.3"> </div>
</div>
<div id="incorrect-list-container" style="display: none;">
    <h4>Missed Countries</h4> <ul id="incorrect-list"></ul>
</div>

<!-- ADDED: Tracker Mode Legend -->
<div id="tracker-legend" style="display: none;">
    Click a country to cycle: Default →
    <span style="color: #4CAF50; font-weight: bold;">Visited</span> →
    <span style="color: #FFEB3B; font-weight: bold;">Wishlist</span> → Default
</div>

<!-- ADDED: Standalone Tracker Back Button -->
<button id="trackerBackBtn" style="display: none;">Back to Menu</button>

<div id="footer"> © Creative Forge 2025 </div>


<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/mapbox-gl@2.15.0/dist/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

<script>
  // --- CONFIGURATION ---
  mapboxgl.accessToken = 'pk.eyJ1IjoienVrdG9vcjIiLCJhIjoiY204dWkydnFyMGJnZDJpb3AycWdubGM1dCJ9.c05BLwdcTXP5QAysXxCQyg';
  const MAX_ROUNDS = 10;
  const COUNTRIES_URL = 'countries.geo.json';
  const BACKGROUND_MUSIC_FILES = ['relax1.mp3', 'relax2.mp3', 'relax3.mp3'];
  const INITIAL_MUSIC_VOLUME = 0.3;
  const LOCAL_STORAGE_VISITED_KEY = 'geospot_visited';
  const LOCAL_STORAGE_WISHLIST_KEY = 'geospot_wishlist';

  // --- DOM ELEMENTS ---
  let mapContainer, splashScreen, startBtn, difficultySelect, timerToggle, countryNameEl,
      timerDisplayEl, totalScoreEl, roundEl, streakEl, feedbackEl, muteBtn,
      volumeSlider, incorrectListEl, incorrectListContainerEl, exitGameBtn,
      travelMapBtn, trackerBackBtn, // <-- ADDED trackerBackBtn, removed old backToMenuBtn
      scoreboardEl, bottomLeftControls,
      trackerLegendEl; // <-- ADDED

  // --- MAP & GAME STATE ---
  let map;
  const game = {
    currentMode: 'menu', // 'menu', 'quiz', 'tracker'
    countriesGeoJson: null, countryFeaturesMap: new Map(), currentCountry: null,
    totalScore: 0, round: 0, streak: 0, timerEnabled: true, difficulty: 'medium',
    timerInterval: null, timeLeft: 0, isInputAllowed: false, currentMarker: null,
    sounds: {}, backgroundMusic: null, isLoaded: false, feedbackTimeout: null,
    isMuted: false, musicVolumePreference: INITIAL_MUSIC_VOLUME, isGameRunning: false,
    incorrectlyGuessedCountries: new Set(),
    visitedCountries: new Set(),
    wishlistCountries: new Set()
  };

  // --- SOUND HANDLING ---
  function loadSounds() { const soundFiles = ['correct', 'wrong', 'timeout', 'start', 'gameover']; soundFiles.forEach(name => { try { game.sounds[name] = new Audio(`${name}.mp3`); game.sounds[name].onerror = () => console.warn(`Could not load sound: ${name}.mp3`); } catch(e) { console.error(`Error creating Audio for ${name}.mp3`, e); } }); }
  function playSound(name) { if (game.isMuted) return; if (game.sounds[name]) { try { game.sounds[name].currentTime = 0; game.sounds[name].play().catch(e => console.warn(`Sound play error (${name}):`, e)); } catch(e) { console.error(`Error playing sound ${name}`, e); } } }
  function startBackgroundMusic() { stopBackgroundMusic(); if (game.isMuted || BACKGROUND_MUSIC_FILES.length === 0 || game.currentMode === 'tracker') return; const randomIndex = Math.floor(Math.random() * BACKGROUND_MUSIC_FILES.length); const musicFile = BACKGROUND_MUSIC_FILES[randomIndex]; console.log(`Starting background music: ${musicFile}`); try { game.backgroundMusic = new Audio(musicFile); game.backgroundMusic.loop = true; game.backgroundMusic.volume = game.musicVolumePreference; volumeSlider.value = game.musicVolumePreference; game.backgroundMusic.play().catch(error => { console.warn(`Background music play error (${musicFile}):`, error); game.backgroundMusic = null; }); } catch(e) { console.error(`Error creating Audio for background music ${musicFile}`, e); game.backgroundMusic = null; } }
  function stopBackgroundMusic() { if (game.backgroundMusic) { try { console.log("Stopping background music"); game.backgroundMusic.pause(); game.backgroundMusic.currentTime = 0; game.backgroundMusic = null; } catch(e) { console.error("Error stopping background music", e); game.backgroundMusic = null; } } }
  function toggleMute() { game.isMuted = !game.isMuted; console.log("Mute toggled. Is muted:", game.isMuted); muteBtn.innerText = game.isMuted ? 'Unmute' : 'Mute'; muteBtn.style.backgroundColor = game.isMuted ? '#f44336' : '#555'; if (game.isMuted) { stopBackgroundMusic(); } else { if (game.isGameRunning) { startBackgroundMusic(); } } }
  function updateMusicVolume(volume) { try { game.musicVolumePreference = parseFloat(volume); console.log("Music volume preference set to:", game.musicVolumePreference); if (game.backgroundMusic) { game.backgroundMusic.volume = game.musicVolumePreference; } } catch(e) { console.error("Error updating volume", e); } }

  // --- UI UPDATES ---
  function updateScoreboard() { if (!totalScoreEl || !roundEl || !streakEl) return; try { totalScoreEl.innerText = game.totalScore; roundEl.innerText = `${game.round}/${MAX_ROUNDS}`; streakEl.innerText = game.streak; } catch(e){ console.error("Error updating scoreboard", e); } }
  function showFeedback(message, type = 'info', duration = 3000) { if (game.currentMode !== 'quiz' || !feedbackEl) return; try { console.log(`Showing feedback (${type}): ${message}`); feedbackEl.innerText = message; feedbackEl.className = `visible ${type}`; if (game.feedbackTimeout) clearTimeout(game.feedbackTimeout); game.feedbackTimeout = setTimeout(() => { if (feedbackEl) feedbackEl.className = ''; game.feedbackTimeout = null; }, duration); } catch(e){ console.error("Error showing feedback", e); } }
  function updateTimerDisplay() { if (game.currentMode !== 'quiz' || !timerDisplayEl) return; try { if (game.timerEnabled && game.timeLeft > 0) { timerDisplayEl.innerText = `(${game.timeLeft}s)`; } else { timerDisplayEl.innerText = ''; } } catch(e){ console.error("Error updating timer display", e); } }
  function clearHighlight() { try { if (map && map.getSource('highlight-source') && map.getLayer('highlight-layer')) { map.getSource('highlight-source').setData({ type: 'FeatureCollection', features: [] }); console.log("Temp highlight cleared."); } } catch(e) { console.error("Error clearing highlight:", e)} }
  function highlightCountry(countryFeature) { if (game.currentMode !== 'quiz') return; const countryName = countryFeature?.properties?.name || "Unknown"; console.log(`Highlighting: ${countryName}`); try { clearHighlight(); if (map && map.getSource('highlight-source') && map.getLayer('highlight-layer') && countryFeature) { map.getSource('highlight-source').setData(countryFeature); } else if (!countryFeature) { console.warn("highlightCountry null feature"); } } catch(e) { console.error("Error highlighting country:", e)} }
  function clearMarker() { try { if (game.currentMarker) { game.currentMarker.remove(); game.currentMarker = null; console.log("Marker cleared"); } } catch(e) { console.error("Error clearing marker:", e)} }
  function addMarker(lngLat, color = 'red') { if (game.currentMode !== 'quiz') return; try { clearMarker(); if (!Array.isArray(lngLat) || lngLat.length !== 2 || typeof lngLat[0] !== 'number' || typeof lngLat[1] !== 'number') { console.error("Invalid LngLat for addMarker:", lngLat); return; } console.log("Adding marker:", lngLat, color); game.currentMarker = new mapboxgl.Marker({ color: color }).setLngLat(lngLat).addTo(map); } catch(e) { console.error("Error adding marker:", e)} }
  function updateMissedCountriesUI() { if (game.currentMode !== 'quiz' || !incorrectListEl || !incorrectListContainerEl) return; try { incorrectListEl.innerHTML = ''; if (game.incorrectlyGuessedCountries.size === 0) { incorrectListContainerEl.classList.remove('visible'); incorrectListContainerEl.style.display = 'none'; } else { incorrectListContainerEl.classList.add('visible'); incorrectListContainerEl.style.display = 'block'; const sortedNames = Array.from(game.incorrectlyGuessedCountries).sort(); sortedNames.forEach(name => { const listItem = document.createElement('li'); listItem.textContent = name; incorrectListEl.appendChild(listItem); }); incorrectListContainerEl.scrollTop = incorrectListContainerEl.scrollHeight; } /* Map updates */ if (map && map.isStyleLoaded() && map.getSource('missed-labels-source')) { const labelFeatures = []; for (const name of game.incorrectlyGuessedCountries) { const feat = game.countryFeaturesMap.get(name); if (feat?.properties?.center) { labelFeatures.push({ type: 'Feature', geometry: { type: 'Point', coordinates: feat.properties.center }, properties: { name } }); } } map.getSource('missed-labels-source').setData({ type: 'FeatureCollection', features: labelFeatures }); } if (map && map.isStyleLoaded() && map.getSource('persistent-red-source')) { const missedFeatures = []; for (const name of game.incorrectlyGuessedCountries) { const feat = game.countryFeaturesMap.get(name); if (feat) missedFeatures.push(feat); } map.getSource('persistent-red-source').setData({ type: 'FeatureCollection', features: missedFeatures }); } } catch(e) { console.error("Error updating missed countries UI", e); } }

  // --- Tracker Data Handling ---
  function loadTrackerData() {
      console.log("Loading tracker data...");
      try { const visitedData = localStorage.getItem(LOCAL_STORAGE_VISITED_KEY); const wishlistData = localStorage.getItem(LOCAL_STORAGE_WISHLIST_KEY); game.visitedCountries = visitedData ? new Set(JSON.parse(visitedData)) : new Set(); game.wishlistCountries = wishlistData ? new Set(JSON.parse(wishlistData)) : new Set(); console.log(`Loaded ${game.visitedCountries.size} visited, ${game.wishlistCountries.size} wishlist.`); }
      catch (e) { console.error("Error loading tracker data:", e); game.visitedCountries = new Set(); game.wishlistCountries = new Set(); }
  }
  function saveTrackerData() {
      try { localStorage.setItem(LOCAL_STORAGE_VISITED_KEY, JSON.stringify(Array.from(game.visitedCountries))); localStorage.setItem(LOCAL_STORAGE_WISHLIST_KEY, JSON.stringify(Array.from(game.wishlistCountries))); console.log(`Saved ${game.visitedCountries.size} visited, ${game.wishlistCountries.size} wishlist.`); }
      catch (e) { console.error("Error saving tracker data:", e); }
  }

  // --- Feature State Management ---
  function applyFeatureStates(clearOnly = false) {
      if (!map || !map.isStyleLoaded() || !game.countriesGeoJson) { console.warn("ApplyFeatureStates: Map/Style/Data not ready."); return; }
      console.log(`Applying feature states (Clear: ${clearOnly})...`);
      try {
          const features = game.countriesGeoJson.features; let updatedCount = 0;
          features.forEach(feature => {
              if (feature.id === undefined) return; // Skip features without ID
              const countryName = feature.properties.name; let visited = false; let wishlist = false;
              if (!clearOnly && countryName) { visited = game.visitedCountries.has(countryName); wishlist = game.wishlistCountries.has(countryName); }
              const currentState = map.getFeatureState({ source: 'countries', id: feature.id }) || {};
              // Set state only if it's different or if clearing is requested and state exists
              if ((currentState.visited !== visited || currentState.wishlist !== wishlist) || (clearOnly && (currentState.visited || currentState.wishlist))) {
                  map.setFeatureState({ source: 'countries', id: feature.id }, { visited: visited, wishlist: wishlist }); updatedCount++;
              }
          });
          console.log(`Applied/Cleared states for ${updatedCount} features.`);
      } catch(e) { console.error("Error applying feature states", e); }
  }

  // --- UI Visibility Management ---
  function setUIVisibility(mode) {
      console.log("Setting UI visibility for mode:", mode);
      try {
          const isMenu = mode === 'menu';
          const isQuiz = mode === 'quiz';
          const isTracker = mode === 'tracker';

          if (splashScreen) { splashScreen.style.display = isMenu ? 'flex' : 'none'; splashScreen.classList.toggle('hidden', !isMenu); }
          // Show scoreboard ONLY in quiz mode now
          if (scoreboardEl) scoreboardEl.style.display = isQuiz ? 'flex' : 'none';
          if (feedbackEl) { feedbackEl.style.display = isQuiz ? 'block' : 'none'; if (!isQuiz) feedbackEl.className = ''; }
          if (exitGameBtn) exitGameBtn.style.display = isQuiz ? 'inline-flex' : 'none';
          if (incorrectListContainerEl) incorrectListContainerEl.style.display = isQuiz && game.incorrectlyGuessedCountries.size > 0 ? 'block' : 'none';

          // Control visibility of the NEW tracker back button
          if (trackerBackBtn) trackerBackBtn.style.display = isTracker ? 'block' : 'none'; // <-- Control new button

          // Tracker Legend Visibility
          if (trackerLegendEl) trackerLegendEl.style.display = isTracker ? 'block' : 'none'; // <-- Control legend visibility

          // Common UI
          if (bottomLeftControls) bottomLeftControls.style.display = 'flex'; // Keep visible always for now

          console.log(`UI Visibility Set for: ${mode}`);
      } catch(e) { console.error("Error setting UI visibility", e); }
  }


  // --- GAME/MODE LOGIC ---
  async function loadGameData() {
      console.log("loadGameData: Starting...");
      try {
          console.log(`Fetching ${COUNTRIES_URL}...`);
          const res = await fetch(COUNTRIES_URL);
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const rawGeoJson = await res.json();
          console.log("JSON parsed.");

          let processedCount = 0, failedCount = 0;
          game.countryFeaturesMap.clear(); const validFeatures = [];
          if (!rawGeoJson?.features) throw new Error("Invalid GeoJSON structure.");

          rawGeoJson.features.forEach((f, index) => {
              f.id = index; // Assign ID for feature state
              if (!f?.properties || !f.geometry) { failedCount++; return; }
              const countryName = f.properties.name;
              try {
                  const center = turf.pointOnFeature(f).geometry.coordinates;
                  f.properties.center = center;
                  f.properties.id = index; // Add id to properties too
                  if (countryName?.trim()) { game.countryFeaturesMap.set(countryName, f); validFeatures.push(f); processedCount++; }
                  else { failedCount++; }
              } catch (e) { console.error(`Processing failed for ${countryName || 'Unnamed'} (Idx ${index}):`, e); f.properties.center = null; failedCount++; }
          });
          console.log(`loadGameData: Processed: ${processedCount}, Failed/Skipped: ${failedCount}`);
          game.countriesGeoJson = { type: "FeatureCollection", features: validFeatures };
          if (validFeatures.length === 0) throw new Error("No valid country features.");

          console.log("Adding/Verifying map sources/layers...");
          // 1. Ensure Source Exists (With promoteId)
          if (!map.getSource('countries')) { map.addSource('countries', { type: 'geojson', data: game.countriesGeoJson, promoteId: 'id' }); console.log("Added 'countries' source with promoteId: 'id'."); }
          else { map.getSource('countries').setData(game.countriesGeoJson); console.log("Updated 'countries' source."); }
          // --- Verification Log ---
           try { const source = map.getSource('countries'); if (source && source.promoteId === 'id') { console.log("Verified: Source 'countries' promoteId is 'id'."); } else if (source) { console.error("Verification FAILED: Source 'countries' promoteId is NOT 'id'.", source.promoteId); } else { console.error("Verification FAILED: Source 'countries' not found!"); } } catch (sourceError) { console.error("Error verifying source:", sourceError); }

          // 2. Ensure Base Border Layer Exists FIRST
          if (!map.getLayer('country-borders')) { map.addLayer({ id: 'country-borders', type: 'line', source: 'countries', paint: { 'line-color': '#ffffff', 'line-width': 0.8, 'line-opacity': 0.6 }}); console.log("Added 'country-borders'."); }
          // 3. Add Tracker Fill Layer
          if (!map.getLayer('country-fills-tracker')) { map.addLayer({ id: 'country-fills-tracker', type: 'fill', source: 'countries', paint: { 'fill-color': ['case', ['boolean', ['feature-state', 'visited'], false], '#4CAF50', ['boolean', ['feature-state', 'wishlist'], false], '#FFEB3B', 'rgba(100, 100, 120, 0.3)'], 'fill-opacity': 0.7 }}, 'country-borders'); console.log("Added 'country-fills-tracker'."); }
          // 4. Add Other Layers
          if (!map.getSource('highlight-source')) { map.addSource('highlight-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } }); }
          if (!map.getLayer('highlight-layer')) { map.addLayer({ id: 'highlight-layer', type: 'fill', source: 'highlight-source', paint: { 'fill-color': '#00ff00', 'fill-opacity': 0.4 } }, 'country-borders'); console.log("Added 'highlight-layer'."); }
          if (!map.getSource('persistent-red-source')) { map.addSource('persistent-red-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } }); }
          if (!map.getLayer('persistent-red-layer')) { map.addLayer({ id: 'persistent-red-layer', type: 'fill', source: 'persistent-red-source', paint: { 'fill-color': '#f44336', 'fill-opacity': 0.35 } }, 'highlight-layer'); console.log("Added 'persistent-red-layer'."); }
          if (!map.getSource('missed-labels-source')) { map.addSource('missed-labels-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } }); }
          if (!map.getLayer('missed-labels-layer')) { map.addLayer({ id: 'missed-labels-layer', type: 'symbol', source: 'missed-labels-source', layout: { 'text-field': ['get', 'name'], 'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'], 'text-size': 12, 'text-anchor': 'top', 'text-offset': [0, 0.6], 'text-allow-overlap': false }, paint: { 'text-color': '#FFDDDD', 'text-halo-color': '#330000', 'text-halo-width': 1.5, 'text-halo-blur': 0.5 } }); console.log("Added 'missed-labels-layer'."); }
          if (!map.getLayer('all-country-labels')) { map.addLayer({ id: 'all-country-labels', type: 'symbol', source: 'countries', layout: { 'text-field': ['get', 'name'], 'text-font': ['Open Sans Regular', 'Arial Unicode MS Regular'], 'text-size': 11, 'text-anchor': 'center', 'text-allow-overlap': false, 'text-optional': true, 'visibility': 'none' }, paint: { 'text-color': '#ffffff', 'text-halo-color': '#111133', 'text-halo-width': 1.5, 'text-halo-blur': 1 }}); console.log("Added 'all-country-labels'."); }

          // 5. Mark as Loaded and Enable Buttons
          game.isLoaded = true; console.log("Game data marked as loaded.");
          if(countryNameEl) countryNameEl.innerText = "Ready!";
          if(startBtn) { startBtn.disabled = false; startBtn.innerText = "Start Game"; }
          if(travelMapBtn) travelMapBtn.disabled = false;
          console.log("loadGameData: Finished successfully.");

      } catch (error) { console.error("--- loadGameData FAILED ---:", error); if(countryNameEl) countryNameEl.innerText = "Error!"; alert(`FATAL: Data Load Failed: ${error.message}. Check console.`); if(startBtn) { startBtn.disabled = true; startBtn.innerText = "Error"; } if(travelMapBtn) travelMapBtn.disabled = true; }
  }

  // --- Updated enterTrackerMode ---
  function enterTrackerMode() {
      if (!game.isLoaded) { alert("Map data not loaded yet."); return; }
      console.log("Entering Tracker Mode...");
      game.currentMode = 'tracker'; game.isGameRunning = false;
      stopBackgroundMusic(); clearMarker(); clearHighlight();
      setUIVisibility('tracker');

      // Show country names in tracker mode
      try { if (map.getLayer('all-country-labels')) { map.setLayoutProperty('all-country-labels', 'visibility', 'visible'); console.log("Tracker Mode: Set country labels visible."); } else { console.warn("Layer 'all-country-labels' not found."); } } catch(e) { console.error("Error showing country labels:", e); }

      map.flyTo({ center: [0, 20], zoom: 1.8, pitch: 0, bearing: 0, speed: 0.8 });
      map.once('idle', () => {
          console.log("Map idle after entering tracker mode. Applying states.");
          loadTrackerData(); applyFeatureStates();
          console.log("Tracker Mode setup complete and idle.");
      });
  }
  // --- Updated exitTrackerMode ---
  function exitTrackerMode() {
      console.log("Exiting Tracker Mode...");
      game.currentMode = 'menu';
      setUIVisibility('menu');
      applyFeatureStates(true); // Clear visuals

      // Hide country names when exiting tracker mode
      try { if (map.getLayer('all-country-labels')) { map.setLayoutProperty('all-country-labels', 'visibility', 'none'); console.log("Exiting Tracker Mode: Set country labels hidden."); } } catch(e) { console.error("Error hiding country labels:", e); }

      console.log("Returned to Menu.");
  }

  function startGame() {
      console.log("startGame called");
      if (!game.isLoaded || game.isGameRunning) { console.warn(`Start denied (Loaded: ${game.isLoaded}, Running: ${game.isGameRunning}).`); return; }

      game.currentMode = 'quiz'; game.isGameRunning = true;
      if (!game.isMuted) playSound('start');
      startBackgroundMusic();
      game.totalScore = 0; game.round = 0; game.streak = 0;
      game.difficulty = difficultySelect.value; game.timerEnabled = timerToggle.checked;
      game.isInputAllowed = false; game.incorrectlyGuessedCountries.clear();
      setUIVisibility('quiz');
      applyFeatureStates(true); // Clear tracker visuals
      updateMissedCountriesUI(); updateScoreboard();

      try { // Tourist labels (only applies if difficulty is Tourist)
          if (map.getLayer('all-country-labels')) { map.setLayoutProperty('all-country-labels', 'visibility', game.difficulty === 'tourist' ? 'visible' : 'none'); }
      } catch(e) { console.error("Error setting tourist labels:", e); }

      setTimeout(() => { console.log("Starting first round..."); pickNextCountry(); }, 500);
  }

  function pickNextCountry() {
       if (game.currentMode !== 'quiz' || !game.isGameRunning) return;
      console.log(`--- pickNextCountry: round ${game.round + 1} ---`);
      clearHighlight(); clearMarker();
      if (game.feedbackTimeout) clearTimeout(game.feedbackTimeout); if(feedbackEl) feedbackEl.className = '';

      if (game.round >= MAX_ROUNDS) { console.log("Max rounds reached."); endGame(); return; }
      game.round++;
      game.currentCountry = getRandomCountry();
      if (!game.currentCountry) { console.error("Failed to get country."); endGame("Error selecting country."); return; }

      console.log(`Selected: ${game.currentCountry.properties.name}`);
      if(countryNameEl) countryNameEl.innerText = game.currentCountry.properties.name;
      updateScoreboard();

      const neutralCenter = [0, 20], neutralZoom = 1.8, neutralPitch = 40, neutralBearing = 0;
      console.log("Resetting view...");
      map.flyTo({ center: neutralCenter, zoom: neutralZoom, pitch: neutralPitch, bearing: neutralBearing, speed: 0.7, curve: 1, essential: true });

      let inputEnabled = false;
      const enableInput = () => {
          if (inputEnabled || !game.isGameRunning || game.currentMode !== 'quiz') return;
          inputEnabled = true; console.log("Enabling quiz input.");
          if (game.timerEnabled) { startTimer(); } else { updateTimerDisplay(); }
          game.isInputAllowed = true;
      };
      map.once('moveend', enableInput);
      setTimeout(() => { if (!inputEnabled && game.isGameRunning && game.currentMode === 'quiz') { console.warn("Moveend fallback."); enableInput(); } }, 1500);
      console.log("pickNextCountry setup finished.");
  }

  function getRandomCountry() {
      console.log("Selecting random country...");
      const features = game.countriesGeoJson?.features;
      if (!features?.length) { console.error("No countries available!"); return null; }
      let attempts = 0; const maxAttempts = features.length * 2;
      while(attempts < maxAttempts) {
        attempts++;
        const idx = Math.floor(Math.random() * features.length);
        const country = features[idx];
        if (country?.properties?.name && country.geometry && country.properties.center && country.id !== undefined) { return country; }
      }
      console.error(`Could not find valid country after ${maxAttempts} attempts.`); return null;
  }

  function startTimer() {
      clearInterval(game.timerInterval);
      const durations = { tourist: 20, easy: 30, medium: 20, hard: 15 };
      game.timeLeft = durations[game.difficulty] || 20;
      console.log(`Starting timer: ${game.timeLeft}s.`);
      updateTimerDisplay();
      game.timerInterval = setInterval(() => {
          if (!game.isGameRunning) { clearInterval(game.timerInterval); return; }
          game.timeLeft--; updateTimerDisplay();
          if (game.timeLeft <= 0) { handleTimeout(); }
      }, 1000);
  }

  function handleTimeout() {
      if (game.currentMode !== 'quiz') return;
      console.log("handleTimeout called");
      clearInterval(game.timerInterval); playSound('timeout');
      game.isInputAllowed = false; game.streak = 0; updateScoreboard();
      const name = game.currentCountry?.properties?.name;
      showFeedback(`⏰ Time's up! It was ${name || '???'}.`, 'incorrect', 4000);
      if(game.currentCountry) {
          if (game.currentCountry.properties?.center) addMarker(game.currentCountry.properties.center, 'orange');
          if (name) { game.incorrectlyGuessedCountries.add(name); updateMissedCountriesUI(); }
      }
      setTimeout(() => { if(game.isGameRunning && game.currentMode === 'quiz') pickNextCountry(); }, 4500);
  }

  // --- Corrected handleMapClick ---
  function handleMapClick(e) {
      console.log(`--- handleMapClick start (Mode: ${game.currentMode}) ---`);
      if (!e?.lngLat?.lng || !e?.lngLat?.lat || !e?.point) { console.error("Invalid click event data:", e); return; }
      const coords = [e.lngLat.lng, e.lngLat.lat];
      const screenPoint = [e.point.x, e.point.y];

      // --- QUIZ MODE ---
      if (game.currentMode === 'quiz') {
           if (!game.isInputAllowed || !game.currentCountry) { console.log(`Quiz click ignored.`); return; }
          console.log(`Processing quiz click at: ${coords}`);
          game.isInputAllowed = false; clearInterval(game.timerInterval);

          const clickPt = turf.point(coords); let isCorrect = false;
          const targetCenter = game.currentCountry.properties?.center;
          const countryName = game.currentCountry.properties?.name || "Unknown";
          const geom = game.currentCountry.geometry;

          if (geom) { try { isCorrect = turf.booleanPointInPolygon(clickPt, geom); } catch (err) { console.error(`PointInPolygon error:`, err); } }
          else { console.warn(`Missing geometry for ${countryName}`); }

          if (isCorrect) {
              console.log("CORRECT"); playSound('correct'); game.streak++;
              const pts = 100 * game.streak; game.totalScore += pts;
              showFeedback(`✅ Correct! +${pts} pts. Streak: ${game.streak}`, 'correct', 3000);
              if (targetCenter) explodeAtLatLng(targetCenter);
              highlightCountry(game.currentCountry); addMarker(coords, 'green');
          } else {
              console.log("INCORRECT"); playSound('wrong'); game.streak = 0;
              if (countryName !== "Unknown") { game.incorrectlyGuessedCountries.add(countryName); updateMissedCountriesUI(); }
              let dist = 'N/A', pts = 0;
              if (targetCenter) { try { const km = turf.distance(coords, targetCenter, {units:'kilometers'}); dist = km.toFixed(0); pts = Math.max(0, Math.round(100 - km / 50)); } catch(err) { dist = 'Err'; } }
              else { dist = 'N/A'; }
              game.totalScore += pts;
              showFeedback(`❌ Incorrect! It was ${countryName}. Dist: ${dist} km. +${pts} pts.`, 'incorrect', 4000);
              addMarker(coords, 'red');
          }
          updateScoreboard();

          if (targetCenter) {
              map.flyTo({ center: targetCenter, zoom: Math.max(map.getZoom(), 4), speed: 0.5, curve: 1.5 });
              map.once('moveend', () => {
                  if (!isCorrect) { addMarker(targetCenter, 'orange'); }
                  if (isCorrect) { setTimeout(clearHighlight, 1000); }
                  const delay = isCorrect ? 1500 : 2500;
                  setTimeout(() => { if(game.isGameRunning && game.currentMode === 'quiz') pickNextCountry(); }, delay);
              });
          } else {
              if (isCorrect) { setTimeout(clearHighlight, 1000); }
              const delay = isCorrect ? 3000 : 4000;
              setTimeout(() => { if(game.isGameRunning && game.currentMode === 'quiz') pickNextCountry(); }, delay);
          }
          console.log(`--- handleMapClick (Quiz) End ---`);

      // --- TRACKER MODE ---
      } else if (game.currentMode === 'tracker') {
          console.log(`Tracker mode detected, querying features at screen point: [${screenPoint.join(', ')}]`);
          const features = map.queryRenderedFeatures(screenPoint, { layers: ['country-fills-tracker'] });

          if (!features.length) { console.log("Tracker click did not hit a feature."); return; }

          const feature = features[0];
          const countryName = feature.properties.name;
          // Use the ID provided by Mapbox via promoteId
          const countryId = feature.id;

          console.log('Clicked feature Name:', countryName, 'Using ID from feature.id:', countryId);

          if (countryName === undefined || countryId === undefined) {
              console.warn("Clicked feature missing name or required ID (feature.id). Cannot set state. Feature:", feature); return;
          }

          console.log(`Tracker processing click for: ${countryName} (ID: ${countryId})`);
          let visited = game.visitedCountries.has(countryName);
          let wishlist = game.wishlistCountries.has(countryName);
          console.log(`Current state in Sets - Visited: ${visited}, Wishlist: ${wishlist}`);

          let nextVisited = false, nextWishlist = false;
          if (visited) { game.visitedCountries.delete(countryName); game.wishlistCountries.add(countryName); nextVisited = false; nextWishlist = true; console.log(`${countryName}: Set state V -> W`); }
          else if (wishlist) { game.wishlistCountries.delete(countryName); nextVisited = false; nextWishlist = false; console.log(`${countryName}: Set state W -> D`); }
          else { game.visitedCountries.add(countryName); nextVisited = true; nextWishlist = false; console.log(`${countryName}: Set state D -> V`); }

          console.log('Calling map.setFeatureState with ID:', countryId, 'New State:', { visited: nextVisited, wishlist: nextWishlist });
          try {
              map.setFeatureState( { source: 'countries', id: countryId }, { visited: nextVisited, wishlist: nextWishlist });
              console.log('map.setFeatureState executed.');
          } catch (stateError) { console.error("ERROR during map.setFeatureState:", stateError); }

          saveTrackerData();

      } else { console.log(`Click ignored in mode: ${game.currentMode}`); }
      console.log(`--- handleMapClick End ---`);
  }
  // --- End of handleMapClick ---

  function endGame(message = `🎉 Game Over! Final Score: ${game.totalScore}`) {
      if (!game.isGameRunning && message !== "Game exited early.") { return; }
      console.log("--- endGame --- Message:", message);
      const wasQuizRunning = game.isGameRunning;
      game.isGameRunning = false; game.isInputAllowed = false;

      if (wasQuizRunning && message !== "Game exited early.") { playSound('gameover'); }
      stopBackgroundMusic(); clearInterval(game.timerInterval);
      clearHighlight(); clearMarker();

      try { if (map.getLayer('all-country-labels')) map.setLayoutProperty('all-country-labels', 'visibility', 'none'); } catch(e) { console.error("Err hiding labels:", e); }
      applyFeatureStates(true); // Clear tracker states

      showFeedback(message, 'info', 10000);
      if(countryNameEl) countryNameEl.innerText = "Game Over";
      updateTimerDisplay();

      setTimeout(() => {
          console.log("Showing splash post-game.");
          game.currentMode = 'menu';
          setUIVisibility('menu');
          if(countryNameEl) countryNameEl.innerText = "Play Again?";
          if(startBtn) { startBtn.disabled = !game.isLoaded; startBtn.innerText = game.isLoaded ? "Start Game" : "Error"; }
          if(travelMapBtn) travelMapBtn.disabled = !game.isLoaded;
      }, 5000);
  }

  function explodeAtLatLng(coords, count = 15) { if (!Array.isArray(coords) || coords.length < 2 || typeof coords[0] !== 'number' || typeof coords[1] !== 'number') { return; } try { const point = map.project(new mapboxgl.LngLat(coords[0], coords[1])); if (!point || isNaN(point.x) || isNaN(point.y)) { return; } for (let i = 0; i < count; i++) { const star = document.createElement('div'); star.className = 'star-explosion'; star.style.left = `${point.x}px`; star.style.top = `${point.y}px`; const angle = Math.random() * 2 * Math.PI; const dist = Math.random() * 80 + 30; star.style.setProperty('--dx', `${Math.cos(angle) * dist}px`); star.style.setProperty('--dy', `${Math.sin(angle) * dist}px`); document.body.appendChild(star); setTimeout(() => star.remove(), 800); } } catch(e) { console.error("Explosion error:", e); } }

  function initializeMap() {
      console.log("initializeMap: Starting...");
      try {
          map = new mapboxgl.Map({
              container: mapContainer, style: 'mapbox://styles/mapbox/satellite-v9', center: [0, 20], zoom: 1.8, pitch: 40, bearing: 0, antialias: true, projection: 'mercator',
              wheelZoomRate: 1 / 150, zoomRate: 0.4
          });
          console.log("Map instance created.");

          map.on('load', () => {
              console.log("map.on('load')");
              try {
                  map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1', 'tileSize': 512, 'maxzoom': 14 });
                  map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 }); console.log("Terrain added.");
                  map.once('idle', () => { console.log("map.on('idle'). Calling loadGameData..."); loadGameData(); });
              } catch(loadErr) { console.error("Err in map load event:", loadErr); alert("Map resources failed to load."); }
              map.addControl(new mapboxgl.NavigationControl(), 'top-right'); map.addControl(new mapboxgl.FullscreenControl());
              map.on('click', handleMapClick); console.log("Map click listener attached.");
          });
          map.on('error', (e) => { console.error('Mapbox Error:', e); alert(`Map Error: ${e.error?.message || 'Unknown'}`); game.isLoaded = false; if(startBtn) startBtn.disabled=true; if(travelMapBtn) travelMapBtn.disabled=true; });
          console.log("Map event listeners attached.");
      } catch (initErr) { console.error("FATAL: initializeMap:", initErr); document.body.innerHTML = `<h1>FATAL MAP ERROR</h1><p>${initErr.message}</p><p>Check console.</p>`; }
      console.log("initializeMap: Finished.");
  }

  // --- STARTUP ---
  document.addEventListener('DOMContentLoaded', () => {
      console.log("DOMContentLoaded: Starting setup...");
      try {
          // Assign DOM elements
          mapContainer = document.getElementById('map'); splashScreen = document.getElementById('splash'); startBtn = document.getElementById('startBtn'); difficultySelect = document.getElementById('difficulty'); timerToggle = document.getElementById('timerToggle'); countryNameEl = document.getElementById('countryName'); timerDisplayEl = document.getElementById('timerDisplay'); totalScoreEl = document.getElementById('totalScore'); roundEl = document.getElementById('round'); streakEl = document.getElementById('streak'); feedbackEl = document.getElementById('feedback'); muteBtn = document.getElementById('muteBtn'); volumeSlider = document.getElementById('volumeSlider'); incorrectListEl = document.getElementById('incorrect-list'); incorrectListContainerEl = document.getElementById('incorrect-list-container'); exitGameBtn = document.getElementById('exitGameBtn');
          travelMapBtn = document.getElementById('travelMapBtn');
          trackerBackBtn = document.getElementById('trackerBackBtn'); // Get the new button
          scoreboardEl = document.getElementById('scoreboard');
          bottomLeftControls = document.getElementById('bottom-left-controls');
          trackerLegendEl = document.getElementById('tracker-legend'); // Get legend

          // Check essential elements
          if (!mapContainer || !splashScreen || !startBtn || !scoreboardEl || !travelMapBtn || !trackerBackBtn /* Check new button */ || !bottomLeftControls || !trackerLegendEl ) {
              throw new Error("One or more critical UI elements not found!");
          }
          console.log("DOM elements assigned.");

          loadSounds(); console.log("Sounds loaded.");
          initializeMap(); console.log("initializeMap called.");

          // Initial UI state
          game.currentMode = 'menu'; console.log("Initial mode: 'menu'");
          setUIVisibility(game.currentMode);

          startBtn.disabled = true; startBtn.innerText = "Loading...";
          travelMapBtn.disabled = true;

          difficultySelect.value = game.difficulty; timerToggle.checked = game.timerEnabled;
          volumeSlider.value = game.musicVolumePreference;
          muteBtn.innerText = game.isMuted ? 'Unmute' : 'Mute'; muteBtn.style.backgroundColor = game.isMuted ? '#f44336' : '#555';
          console.log("Initial UI state configured.");

          // Attach event listeners
          console.log("Attaching event listeners...");
          startBtn.onclick = startGame;
          exitGameBtn.onclick = () => { if (game.isGameRunning) { endGame("Game exited early."); } };
          travelMapBtn.onclick = enterTrackerMode;
          trackerBackBtn.onclick = exitTrackerMode; // ADDED listener for new button
          difficultySelect.onchange = () => { game.difficulty = difficultySelect.value; };
          timerToggle.onchange = () => { game.timerEnabled = timerToggle.checked; };
          muteBtn.onclick = toggleMute;
          volumeSlider.oninput = () => { updateMusicVolume(volumeSlider.value); };
          console.log("Event listeners attached.");

      } catch(startupError) {
          console.error("--- DOMContentLoaded FAILED ---:", startupError);
          document.body.innerHTML = `<div style="padding: 20px; color: red; font-size: 18px;"><h1>FATAL STARTUP ERROR</h1><p>${startupError.message}</p><p>Check console (F12).</p></div>`;
      }
      console.log("DOMContentLoaded: Setup finished.");
  });
</script>

</body>
</html>
